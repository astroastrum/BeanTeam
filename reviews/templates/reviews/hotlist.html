{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block content %}
  <div id="carouselExampleControls" class="carousel slide w-75 my-3 mx-auto" data-bs-ride="carousel">
    <div class="carousel-inner">
      {% for img in location.image.all %}
        {% if forloop.first %}
          <div class="carousel-item active">
            <img src="{{ img.image.url }}" class="d-block w-100" alt="...">
          </div>
        {% else %}
          <div class="carousel-item">
            <img src="{{ img.image.url }}" class="d-block w-100" alt="...">
          </div>
        {% endif %}
      {% endfor %}
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>

  <div class="container position-relative">
    <a href="{% url 'reviews:hotcreate' location.pk %}" class="btn btn-primary position-fixed" style="right:10%; bottom:20%; font-size:larger; z-index:1;">명소 추가하기</a>
</div>

<div class="d-flex justify-content-center mt-3 my-3" style="height: 35px;">
  <form class="d-flex" role="search" action=" {% url 'reviews:search' %}">
    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search"
        name="search">
    <button class="btn btn-outline-dark" type="submit">Search</button>
  </form>
</div>
  {% for hotplace in hotplaces %}
    <div class="row g-0 mt-3 border rounded">
      <div class="col-md-8">
        <div class="card-body m-3">
          <a href="{% url 'reviews:hotdetail' hotplace.pk %}" style="text-decoration:none; color:black;">
            <h6 class="card-title fw-bold">{{ hotplace.hotplace }}</h6>
          </a>
          <p class="card-text">{{ hotplace.theme }} | {{ location.location }} | {{ hotplace.addr }}</p>
          <!-- star -->
          <link href="/assets/css/star.css" rel="stylesheet"/>
          <form class="mb-1" name="starform" id="starform" method="post">
            <fieldset>
              <span class="text-bold">별점</span>
              <input type="radio" name="reviewStar" value="5" id="rate1">
              <label for="rate1">★</label>
              <input type="radio" name="reviewStar" value="4" id="rate2">
              <label for="rate2">★</label>
              <input type="radio" name="reviewStar" value="3" id="rate3">
              <label for="rate3">★</label>
              <input type="radio" name="reviewStar" value="2" id="rate4">
              <label for="rate4">★</label>
              <input type="radio" name="reviewStar" value="1" id="rate5">
              <label for="rate5">★</label>
            </fieldset>
          </form>
          <p class="card-text">
            <small class="text-muted">Last updated 3 mins ago</small>
          </p>
          <a href="#" class="btn btn-info btn-sm">예약가능</a>

            {% if request.user.is_authenticated %}
                {% if request.user in hotplace.like_users.all %}
                  <i id="like-btn" data-hotplace-id="{{ hotplace.pk }}" class="bi bi-heart-fill" style="color:red"></i>
                {% else %}
                  <i id="like-btn" data-hotplace-id="{{ hotplace.pk }}" class="bi bi-heart" style="color:red"></i>
                {% endif %}
              <span id="like-count" >{{ hotplace.like_users.count }}</span>
              <i class="bi bi-chat"></i> {{ hotplace.reviews.count }}
            {% endif %}

        </div>
      </div>
      <div class="col-md-4">
        {% for img in hotplace.image.all %}
          {% if forloop.first %}
          <a href="{% url 'reviews:hotdetail' hotplace.pk %}" style="text-decoration:none; color:black;">
            <div class="position-relative">
              <img class="w-100 rounded-end" src="{{ img.image.url }}" alt="">
              
            </div>
          </a>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% endfor %}


  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // (1) 좋아요 버튼
    const likeBtn = document.querySelector('#like-btn')
    // (2) 좋아요 버튼을 클릭하면, 함수 실행
    likeBtn.addEventListener('click', function (event) {
      // 서버로 비동기 요청을 하고 싶음
      console.log(event.target.dataset)
      axios({
        method: 'get',
        url: `/reviews/${event.target.dataset.hotplaceId}/like`
      })
      .then(response => {
        console.log(response)
        console.log(response.data)
        // event.target.classList.toggle('bi-heart')
        // event.target.classList.toggle('bi-heart-fill')
        if (response.data.isLiked === true) {
          event.target.classList.add('bi-heart-fill')
          event.target.classList.remove('bi-heart')
        } else {
          event.target.classList.add('bi-heart')
          event.target.classList.remove('bi-heart-fill')
        }
        const likeCount = document.querySelector('#like-count')
        likeCount.innerText = response.data.likeCount
      })
    })
  </script>
{% endblock %}